@page "/"
@using API;
@using API.Models;
@using BlazorApp.Pages;
@using BlazorApp.Containers;
@using System.Threading.Tasks;
@using Syncfusion.Blazor.Charts;
@using Microsoft.AspNetCore.Components.Forms;
@using Syncfusion.Blazor.Charts.Chart.Internal;

@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject Microsoft.AspNetCore.Components.NavigationManager NavigationManager
@inject NavigationManager Navigation
@inject IJSRuntime JS

@namespace BlazorApp.Components.Pages


<PageTitle>Home</PageTitle>

<h1>Home</h1>

<div class="d-flex">
    <!-------------------------------- Create Plant ------------------------------->
    @if (AccountSession.UserSession != null)
    {
        <div>
            <!-- Trigger/Open The Modal -->
            <button id="myBtnCreatePlant" class="btn btn-primary buttons">Create Plant</button>

            <!-- The Modal -->
            <div id="myModalCreatePlant" class="modal">

                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close">&times;</span>

                    <div class="modal-header">
                        <h5 class="modal-title">Create Plant</h5>
                    </div>

                    <!-- EditForm for login -->
                    <EditForm Model="@createPlantProfile">
                        <div class="modal-body">

                            <!-- Input fields for login -->
                            <label for="plantName">Plant Name:</label><br>
                            <div class="form-group">
                                <InputText id="plantName" @bind-Value="createPlantProfile.PlantName" placeholder="Plant Name" required /><br><br>
                            </div>

                            <label for="plantMinMoisture">Plant Minimum Moisture:</label><br>
                            <div class="form-group">
                                <InputNumber id="plantMinMoisture" @bind-Value="createPlantProfile.MinWaterLevel" placeholder="Minimum Moisture:" required /><br><br>
                            </div>

                            <label for="plantMaxMoisture">Plant Maximum Moisture:</label><br>
                            <div class="form-group">
                                <InputNumber id="plantMaxMoisture" @bind-Value="createPlantProfile.MaxWaterLevel" placeholder="Maximum Moisture:" required /><br><br>
                            </div>

                        </div>

                        <div class="modal-footer">
                            @if (createPlantProfile.PlantName == null || createPlantProfile.MinWaterLevel == 0 || createPlantProfile.MaxWaterLevel == 0)
                            {
                                <!-- Buttons for login -->
                                <button disabled type="submit" class="btn btn-primary" @onclick="HandleCreatePlant">Submit</button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-primary" @onclick="HandleCreatePlant">Submit</button>
                            }
                        </div>

                        <p class="error-message" id="login-error">@errorMessageCreatePlant</p>

                    </EditForm>
                </div>
            </div>
        </div>
    }
    <!--------------------------------- Edit Plant -------------------------------->
    @if (AccountSession.UserSession != null)
    {
        <div>
            <!-- Trigger/Open The Modal -->
            <button id="myBtnEditPlant" class="btn btn-primary buttons">Edit Plant</button>

            <!-- The Modal -->
            <div id="myModalEditPlant" class="modal">

                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close">&times;</span>

                    <div class="modal-header">
                        <h5 class="modal-title">Edit Plant</h5>
                    </div>

                    <!-- EditForm for login -->
                    <EditForm Model="@plantProfile">
                        <div class="modal-body">
                            <p>selected plant: @selectedEditPlant</p>
                            <!-- Input fields for login -->
                            <div class="dropdown">

                                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <text>Choose Plant</text>
                                </button>

                                <ul class="dropdown-menu">
                                    @if (Useronlyplants != null && Useronlyplants.Count > 0)
                                    {
                                        @foreach (var plant in Useronlyplants)
                                        {
                                            <li><button class="dropdown-item" @onclick="() => SelectEditPlant(plant)">@plant.PlantName</button></li>
                                        }
                                    }
                                    else
                                    {
                                        <li><span class="dropdown-item">No plants made</span></li>
                                    }
                                </ul>

                            </div>
                            <label for="editplantName">Plant Name:</label><br>
                            <div class="form-group">
                                <InputText id="editplantName" @bind-Value="plantProfile.PlantName" required /><br><br>
                            </div>

                            <label for="plantMinMoisture">Plant Minimum Moisture:</label><br>
                            <div class="form-group">
                                <InputNumber id="plantMinMoisture" @bind-Value="plantProfile.MinWaterLevel" placeholder="Minimum Moisture:" required /><br><br>
                            </div>

                            <label for="plantMaxMoisture">Plant Maximum Moisture:</label><br>
                            <div class="form-group">
                                <InputNumber id="plantMaxMoisture" @bind-Value="plantProfile.MaxWaterLevel" placeholder="Maximum Moisture:" required /><br><br>
                            </div>

                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" @onclick="HandleEditPlant">Save Changes</button>
                            <button type="submit" class="btn btn-primary" @onclick="HandlePlantDelete" style="background-color:red;">Delete plant</button>
                        </div>

                        <p class="error-message" id="login-error">@errorMessageEditPlant</p>
                        <p class="error-message" id="login-error">@errorMessageDeletePlant</p>

                    </EditForm>
                </div>
            </div>
        </div>
    }
    <!-------------------------------- Setup Sensor ------------------------------->
    <!-------------------------------- make put request in settings then we change plant name in setup sensor ------------------------------->
    @if (AccountSession.UserSession != null)
    {
        <div>
            <!-- Trigger/Open The Modal -->
            <button id="myBtnSetupSensor" class="btn btn-primary buttons">Setup Sensor</button>

            <!-- The Modal -->
            <div id="myModalSetupSensor" class="modal">

                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close">&times;</span>

                    <div class="modal-header">
                        <h5 class="modal-title">Setup Sensor</h5>
                    </div>

                    <h3>@sensorName1</h3>
                    <p>selected plant: @selectedPlant1</p>

                    <div class="dropdown">

                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <text>Choose Plant</text>
                        </button>

                        <ul class="dropdown-menu">
                            @if (plants != null)
                            {
                                @foreach (var plant in plants)
                                {
                                    <li><button class="dropdown-item" @onclick=" ()=> SelectPlant1(plant)">@plant.PlantName</button></li>
                                    //@settings.Sensor1Name = plant.PlantName;
                                }
                            }
                            else
                            {
                                <li><span class="dropdown-item">Loading...</span></li>
                            }
                        </ul>

                    </div>

                    <div class="d-flex">
                        @if (isEditingSensorName2)
                        {
                            <input type="text" @bind="sensorName2" class="form-control" />
                            <button class="btn btn-success" @onclick="PutSensorNames">Save</button>
                            <button class="btn btn-secondary" @onclick="CancelEditSensorName2">Cancel</button>
                        }
                        else
                        {
                            <h3>@sensorName2</h3>
                            <img class="editIcon" src="https://static.vecteezy.com/system/resources/thumbnails/019/552/591/small/sign-up-icon-signup-square-box-on-transparent-background-free-png.png" @onclick="EditSensorName2" style="cursor:pointer;" />
                        }
                    </div>
                    <p>selected plant: @selectedPlant2</p>

                    <div class="dropdown">

                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <text>Choose Plant</text>
                        </button>

                        <ul class="dropdown-menu">
                            @if (plants != null)
                            {
                                @foreach (var plant in plants)
                                {
                                    <li><button class="dropdown-item" @onclick="() => SelectPlant2(plant)">@plant.PlantName</button></li>
                                }
                            }
                            else
                            {
                                <li><span class="dropdown-item">Loading...</span></li>
                            }
                        </ul>

                    </div>
                    <p class="error-message" id="login-error">@errorMessage</p>
                    <div class="modal-footer">
                        <!-- Buttons for login -->
                        <button type="submit" class="btn btn-primary" @onclick="SetupSensor">Save Changes</button>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
        </div>
    }
</div>

<!-------------------------------- Modal Script ------------------------------->

<script>
    var modals = document.querySelectorAll('.modal');
    var buttons = document.querySelectorAll('.btn-primary.buttons');
    var spans = document.querySelectorAll('.close');

    buttons.forEach(function (button, index) {
        button.addEventListener('click', function () {
            modals[index].style.display = "block";
            errorMessage = "";
        });
    });

    spans.forEach(function (span, index) {
        span.addEventListener('click', function () {
            modals[index].style.display = "none";
            errorMessage = "";
        });
    });

    window.onclick = function (event) {
        modals.forEach(function (modal) {
            if (event.target == modal) {
                modal.style.display = "none";
                errorMessage = "";
            }
        });
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "none";
        }
    }
</script>

<!--------------------------------- Plant Code -------------------------------->
<tr>
    @code {
        private string selectedPlant1 = "";
        private string selectedPlant2 = "";
        private string selectedEditPlant = "";
        private int selectedEditPlantId = 0;
        private string sensorName1 = "";
        private string sensorName2 = "";
        private bool isEditingSensorName2 = false;
        private int settingsId; // Store settings ID

        protected override async Task OnInitializedAsync()
        {
            await GetListOfPlants(); // This method should populate the 'plants' list
            await GetListOfSettings();
        }

        private void SelectedSensorName1(PutSettings name)
        {
            sensorName1 = name.Sensor1Name;
        }

        private void SelectedSensorName2(PutSettings name)
        {
            sensorName2 = name.Sensor2Name;
        }

        private void SelectPlant1(Plant plant)
        {
            selectedPlant1 = plant.PlantName;
        }

        private void SelectPlant2(Plant plant)
        {
            selectedPlant2 = plant.PlantName;
        }

        private void SelectEditPlant(Plant plant)
        {
            selectedEditPlant = plant.PlantName;
            selectedEditPlantId = plant.Id;
        }

        private void EditSensorName2()
        {
            isEditingSensorName2 = true;
        }

        private void SaveSensorName2()
        {
            isEditingSensorName2 = false;
            settings.Sensor2Name = sensorName2;
        }

        private void CancelEditSensorName2()
        {
            isEditingSensorName2 = false;
            // Reset the sensorName2 to its original value if needed
        }
    }
</tr>
